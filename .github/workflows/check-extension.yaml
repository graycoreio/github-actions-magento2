name: MageCheck Extension
on:
 workflow_call:
  inputs:
    path:
        type: string
        required: false
        default: "."
        description: "The folder of the Magento store or extension that you are testing."

    magento_repository:
        type: string
        required: false
        default: "https://mirror.mage-os.org/"
        description: "Where to install Magento from"

    matrix:
        type: string
        required: true
        description: "The matrix of Magento versions to test against"

    fail-fast:
        type: boolean
        required: false
        default: true

    composer_cache_key:
        type: string
        required: false
        default: "_mageos"
        description: A key to version the composer cache. Can be incremented if you need to bust the cache.
jobs:
    unit-test-extension:
        runs-on:  ${{ matrix.os }}
        strategy:
            matrix: ${{ fromJSON(inputs.matrix) }}
            fail-fast: ${{ inputs.fail-fast }}
        steps:
        - uses: actions/checkout@v6

        - uses: graycoreio/github-actions-magento2/setup-magento@main
          id: setup-magento
          with:
            php-version: ${{ matrix.php }}
            tools: composer:v${{ matrix.composer }}
            mode: extension
            magento_version: ${{ matrix.magento }}
            magento_repository: ${{ inputs.magento_repository }}

        - uses: graycoreio/github-actions-magento2/cache-magento@main
          with:
            mode: extension
            composer_cache_key: ${{ inputs.composer_cache_key }}

        - name: Add extension repository
          working-directory: ${{ steps.setup-magento.outputs.path }}
          run: composer config repositories.local path ${{ github.workspace }}/${{ inputs.path }}

        - name: Get package name
          id: package
          run: echo "name=$(jq -r .name ${{ github.workspace }}/${{ inputs.path }}/composer.json)" >> $GITHUB_OUTPUT

        - name: Require extension
          working-directory: ${{ steps.setup-magento.outputs.path }}
          run: composer require "${{ steps.package.outputs.name }}:@dev" --no-install

        - name: Composer install
          working-directory: ${{ steps.setup-magento.outputs.path }}
          run: composer install

        - name: Configure phpunit.xml.dist
          working-directory: ${{ steps.setup-magento.outputs.path }}
          run: |
            ## Add the testsuite
            cat > /tmp/testsuite.xml << 'EOF'
                    <testsuite name="Extension_Unit_Tests">
                        <directory>../../../vendor/${{ steps.package.outputs.name }}/Test/Unit</directory>
                    </testsuite>
            EOF
            sed -i '/<testsuites>/r /tmp/testsuite.xml' dev/tests/unit/phpunit.xml.dist

            ## Disable allure (See https://github.com/magento/magento2/issues/36702 )
            ## (╯°□°)╯︵ ┻━┻
            sed -i '/<extensions>/,/<\/extensions>/d' dev/tests/unit/phpunit.xml.dist

        - name: Run extension unit tests
          working-directory: ${{ steps.setup-magento.outputs.path }}
          run: vendor/bin/phpunit -c dev/tests/unit/phpunit.xml.dist --testsuite Extension_Unit_Tests

    compile-extension:
        runs-on:  ${{ matrix.os }}
        strategy:
            matrix: ${{ fromJSON(inputs.matrix) }}
            fail-fast: ${{ inputs.fail-fast }}
        steps:
        - uses: actions/checkout@v6

        - uses: graycoreio/github-actions-magento2/setup-magento@main
          id: setup-magento
          with:
            php-version: ${{ matrix.php }}
            tools: composer:v${{ matrix.composer }}
            mode: extension
            magento_version: ${{ matrix.magento }}
            magento_repository: ${{ inputs.magento_repository }}

        - uses: graycoreio/github-actions-magento2/cache-magento@main
          with:
            mode: extension
            composer_cache_key: ${{ inputs.composer_cache_key }}

        - name: Add extension repository
          working-directory: ${{ steps.setup-magento.outputs.path }}
          run: composer config repositories.local path ${{ github.workspace }}/${{ inputs.path }}

        - name: Get package name
          id: package
          run: echo "name=$(jq -r .name ${{ github.workspace }}/${{ inputs.path }}/composer.json)" >> $GITHUB_OUTPUT

        - name: Require extension
          working-directory: ${{ steps.setup-magento.outputs.path }}
          run: composer require "${{ steps.package.outputs.name }}:@dev" --no-install

        - name: Composer install
          working-directory: ${{ steps.setup-magento.outputs.path }}
          run: composer install

        - name: Enable all modules
          working-directory: ${{ steps.setup-magento.outputs.path }}
          run: php bin/magento module:enable --all

        - name: Compile
          working-directory: ${{ steps.setup-magento.outputs.path }}
          run: php bin/magento setup:di:compile

    coding-standard:
      runs-on:  ${{ matrix.os }}
      strategy:
          matrix: ${{ fromJSON(inputs.matrix) }}
          fail-fast: ${{ inputs.fail-fast }}
      steps:
      - uses: actions/checkout@v6
          
      - name: Get Composer Version
        uses: graycoreio/github-actions-magento2/get-composer-version@main
        id: get-composer-version

      - name: Check if allow-plugins option is available for this version of composer
        uses: graycoreio/github-actions-magento2/semver-compare@main
        with:
          version: 2.2
          compare_against: ${{ steps.get-composer-version.outputs.version }}
        id: is-allow-plugins-available

      - name: Enable dealerdirect/phpcodesniffer-composer-installer plugin
        shell: bash
        working-directory: ${{ inputs.path }}
        run: composer config allow-plugins.dealerdirect/phpcodesniffer-composer-installer  true --global
        if: steps.is-allow-plugins-available.outputs.result < 1

      - name: Install Coding Standard
        shell: bash
        working-directory: ${{ inputs.path }}
        run: composer require "magento/magento-coding-standard" "magento/php-compatibility-fork"

      - name: Register Coding Standard
        shell: bash
        working-directory: ${{ inputs.path }}
        run: vendor/bin/phpcs --config-set installed_paths vendor/magento/magento-coding-standard,vendor/magento/php-compatibility-fork

      - name: Get Changed Files
        shell: bash
        working-directory: ${{ inputs.path }}
        id: changed-files
        run: echo "files=$(git diff --name-only --diff-filter=ACMRT ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | xargs)" >> $GITHUB_OUTPUT
        if: github.event_name == 'pull_request'

      - name: Coding Standard Check
        shell: bash
        run: |
          ./vendor/bin/phpcs --standard=Magento2 \
          ${{ github.event_name == 'pull_request' && steps.changed-files.outputs.files }} .
        working-directory: ${{ inputs.path }}